name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Lint Frontend
      run: npm run lint --workspace=packages/frontend
    
    - name: Lint Backend
      run: npm run lint --workspace=packages/backend

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build Shared (for type checking)
      run: |
        cd packages/shared
        rm -rf dist tsconfig.tsbuildinfo
        npm run build
    
    - name: Verify Shared Build (for type checking)
      run: |
        if [ ! -f "packages/shared/dist/config/env.d.ts" ]; then
          echo "❌ Shared build failed: env.d.ts not found"
          echo "Contents of packages/shared/dist:"
          find packages/shared/dist -type f 2>/dev/null || echo "No files found in dist"
          exit 1
        fi
        echo "✅ Shared build verification passed"
    
    - name: Type Check Frontend
      run: npm run type-check --workspace=packages/frontend
    
    - name: Type Check Backend
      run: npm run type-check --workspace=packages/backend

  test:
    name: Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test

  build:
    name: Build Verification
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build Shared
      run: |
        cd packages/shared
        rm -rf dist tsconfig.tsbuildinfo
        npm run build
    
    - name: Verify Shared Build
      run: |
        if [ ! -f "packages/shared/dist/config/env.d.ts" ]; then
          echo "❌ Shared build failed: env.d.ts not found"
          echo "Contents of packages/shared/dist:"
          find packages/shared/dist -type f 2>/dev/null || echo "No files found in dist"
          exit 1
        fi
        echo "✅ Shared build verification passed"
    
    - name: Build Backend
      run: npm run build:backend
    
    - name: Build Frontend
      run: npm run build:frontend
    
    - name: Verify build artifacts
      run: |
        if [ ! -d "packages/frontend/dist" ]; then
          echo "❌ Frontend build failed: dist directory not found"
          exit 1
        fi
        if [ ! -d "packages/backend/dist" ]; then
          echo "❌ Backend build failed: dist directory not found"
          exit 1
        fi
        echo "✅ Build verification passed"

  i18n-validation:
    name: i18n Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-node-20.x-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-20.x-
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Validate i18n translation keys
      run: npm test --workspace=packages/frontend

  # Integration Tests (preparado para implementação futura)
  # Descomente e configure quando os testes de integração estiverem prontos
  # integration-tests:
  #   name: Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: [lint, type-check]
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v6
  #   
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: '20.x'
  #       cache: 'npm'
  #   
  #   - name: Cache node modules
  #     uses: actions/cache@v4
  #     with:
  #       path: |
  #         node_modules
  #         packages/*/node_modules
  #       key: ${{ runner.os }}-node-20.x-${{ hashFiles('**/package-lock.json') }}
  #       restore-keys: |
  #         ${{ runner.os }}-node-20.x-
  #         ${{ runner.os }}-node-
  #   
  #   - name: Install dependencies
  #     run: npm ci
  #   
  #   - name: Setup test database
  #     run: |
  #       # Setup Supabase test instance or mock
  #       echo "Setting up test database..."
  #   
  #   - name: Run integration tests
  #     run: npm run test:integration

  # E2E Tests (preparado para implementação futura com Playwright)
  # Descomente e configure quando os testes E2E estiverem prontos
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: [build]
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v6
  #   
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: '20.x'
  #       cache: 'npm'
  #   
  #   - name: Cache node modules
  #     uses: actions/cache@v4
  #     with:
  #       path: |
  #         node_modules
  #         packages/*/node_modules
  #       key: ${{ runner.os }}-node-20.x-${{ hashFiles('**/package-lock.json') }}
  #       restore-keys: |
  #         ${{ runner.os }}-node-20.x-
  #         ${{ runner.os }}-node-
  #   
  #   - name: Install dependencies
  #     run: npm ci
  #   
  #   - name: Install Playwright browsers
  #     run: npx playwright install --with-deps
  #   
  #   - name: Build application
  #     run: npm run build:all
  #   
  #   - name: Start application
  #     run: |
  #       npm run start:backend &
  #       npm run preview &
  #       sleep 10
  #   
  #   - name: Run E2E tests
  #     run: npm run test:e2e
  #   
  #   - name: Upload test results
  #     if: always()
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: playwright-report
  #       path: playwright-report/
  #       retention-days: 30
